<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>乳化処理 在庫・発注カレンダー</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{
      --bg:#0b1220; --card:#121a2a; --card2:#0f172a;
      --text:#e5e7eb; --muted:#9ca3af; --accent:#38bdf8;
      --warn:#fbbf24; --danger:#fb7185; --ok:#34d399;
      --line:#243046;
      --font: system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif;
    }
    body{margin:0;background:linear-gradient(180deg,#060b14,#0b1220);color:var(--text);font-family:var(--font);}
    .wrap{max-width:1100px;margin:0 auto;padding:14px;}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:10px;background:#0ea5e9;display:grid;place-items:center;font-weight:800}
    h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--card);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:14px;font-weight:700;cursor:pointer}
    .btn:active{transform:scale(.98)}
    .btn.primary{background:#0ea5e9;border-color:#0ea5e9;color:#062235}
    .btn.ghost{background:transparent}
    .pill{background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.35);padding:8px 10px;border-radius:999px;font-weight:700}
    .grid{display:grid;grid-template-columns: 360px 1fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(18,26,42,.9);border:1px solid var(--line);border-radius:18px;padding:14px}
    .card h2{margin:0 0 10px 0;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;min-width:120px}
    label{font-size:12px;color:var(--muted)}
    input, select{background:var(--card2);border:1px solid var(--line);color:var(--text);padding:10px;border-radius:14px;font-size:14px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
    td{background:rgba(15,23,42,.75);border:1px solid var(--line);padding:10px 8px;border-left-width:0;border-right-width:0}
    tr td:first-child{border-left-width:1px;border-radius:14px 0 0 14px}
    tr td:last-child{border-right-width:1px;border-radius:0 14px 14px 0}
    .small{font-size:12px;color:var(--muted)}
    .kpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .kpi .box{background:rgba(15,23,42,.7);border:1px solid var(--line);border-radius:16px;padding:10px}
    .kpi .title{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:18px;font-weight:900;margin-top:4px}
    .tag{display:inline-block;font-weight:900;padding:4px 8px;border-radius:999px;font-size:12px}
    .tag.ok{background:rgba(52,211,153,.18);border:1px solid rgba(52,211,153,.35)}
    .tag.warn{background:rgba(251,191,36,.18);border:1px solid rgba(251,191,36,.35)}
    .tag.danger{background:rgba(251,113,133,.18);border:1px solid rgba(251,113,133,.35)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:rgba(15,23,42,.55);border:1px solid var(--line);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900}
    .tab.active{background:rgba(14,165,233,.22);border-color:rgba(14,165,233,.55)}
    .calwrap{display:flex;flex-direction:column;gap:10px}
    .months{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width: 980px){.months{grid-template-columns:1fr}}
    .month{background:rgba(15,23,42,.55);border:1px solid var(--line);border-radius:18px;padding:10px}
    .month h3{margin:0 0 8px 0;font-size:15px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{font-size:11px;color:var(--muted);text-align:center}
    .day{background:rgba(2,6,23,.35);border:1px solid rgba(36,48,70,.8);border-radius:14px;padding:8px;min-height:82px;display:flex;flex-direction:column;gap:6px}
    .day.muted{opacity:.45}
    .day.today{outline:2px solid rgba(56,189,248,.6)}
    .topline{display:flex;justify-content:space-between;align-items:center}
    .dnum{font-weight:900}
    .shift{display:flex;gap:6px;align-items:center}
    .shift label{color:var(--text);font-size:12px}
    .chk{transform:scale(1.2)}
    .mini{display:flex;flex-direction:column;gap:3px}
    .mini .line{display:flex;justify-content:space-between;font-size:11px;color:var(--muted)}
    .mini .line strong{color:var(--text)}
    .bar{height:6px;border-radius:999px;background:rgba(156,163,175,.22);overflow:hidden;border:1px solid rgba(36,48,70,.8)}
    .bar > div{height:100%}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
    .foot{margin-top:12px;color:var(--muted);font-size:12px}
    .dangerText{color:var(--danger);font-weight:900}
    .okText{color:var(--ok);font-weight:900}
    .warnText{color:var(--warn);font-weight:900}
    .note{background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.35);border-radius:16px;padding:10px}
    .hr{height:1px;background:rgba(36,48,70,.8);margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">乳</div>
        <div>
          <h1>乳化処理 在庫・発注カレンダー</h1>
          <div class="sub">今月・来月・再来月を連動表示（年またぎ対応）</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn ghost" id="prevBtn">◀ 前の月</button>
        <span class="pill" id="viewLabel">----</span>
        <button class="btn ghost" id="nextBtn">次の月 ▶</button>
        <select id="rangeSel" title="表示範囲">
          <option value="3">3ヶ月表示</option>
          <option value="6">6ヶ月表示</option>
          <option value="12">12ヶ月表示</option>
        </select>
        <button class="btn primary" id="saveBtn">保存</button>
        <button class="btn" id="exportBtn">書出し(JSON)</button>
        <button class="btn" id="importBtn">読込(JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display:none"/>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>設定（最初だけ）</h2>
        <div class="note small">
          ✅ <b>最初に1回だけ</b>「基準月（=最初に使い始めた月）」と「月初在庫」を入れてください。<br>
          以降は、月送りしても在庫が自動でつながります。
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>基準年</label>
            <input id="baseYear" type="number" min="2020" max="2100"/>
          </div>
          <div class="field">
            <label>基準月</label>
            <input id="baseMonth" type="number" min="1" max="12"/>
          </div>
          <div class="field" style="min-width:140px">
            <label>納期(発注→納品) 日数</label>
            <input id="leadDays" type="number" min="0" max="60"/>
          </div>
        </div>

        <div class="hr"></div>

        <h2>薬品と使用量</h2>
        <table>
          <thead>
            <tr>
              <th>薬品</th><th>月初在庫(L)</th><th>昼使用(L)</th><th>夜使用(L)</th>
              <th>発注ライン1(cm)</th><th>発注ライン2(cm)</th><th>入荷量(L)</th>
            </tr>
          </thead>
          <tbody id="chemRows"></tbody>
        </table>

        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div class="small">基準：100L = 10cm（1cm=10L） / タンク最大 2000L</div>
          <div class="row">
            <button class="btn" id="wkBtn">平日☑ / 土日☐</button>
            <button class="btn" id="clearBtn">全部☐</button>
          </div>
        </div>

        <div class="hr"></div>
        <h2>今日の目安</h2>
        <div class="kpi" id="kpi"></div>

        <div class="foot">
          ※ iPadとPCは自動同期しません。端末間は「書出し(JSON)」→「読込(JSON)」で引き継げます。
        </div>
      </div>

      <div class="card calwrap">
        <div class="tabs">
          <div class="tab" id="tabThis">今月</div>
          <div class="tab" id="tabNext">来月</div>
          <div class="tab" id="tabNext2">再来月</div>
        </div>
        <div class="legend small">
          <span><span class="dot" style="background:rgba(52,211,153,.7)"></span>安全</span>
          <span><span class="dot" style="background:rgba(251,191,36,.8)"></span>発注ライン1付近</span>
          <span><span class="dot" style="background:rgba(251,113,133,.85)"></span>発注ライン2付近</span>
        </div>
        <div class="months" id="months"></div>
      </div>
    </div>
  </div>

<script>
const STORAGE_KEY = "emulsion_inventory_v4";
const MAX_L = 2000;
const L_PER_CM = 10; // 1cm=10L

const CHEMS = [
  {id:"naoh", name:"苛性ソーダ", inDefault:600, dayUse:4.0, nightUse:4.0, line1cm:170, line2cm:100},
  {id:"fecl2", name:"塩化第二鉄", inDefault:1500, dayUse:2.0, nightUse:2.0, line1cm:70, line2cm:70},
  {id:"h2so4", name:"希硫酸",   inDefault:1500, dayUse:0.5, nightUse:0.5, line1cm:30, line2cm:30},
];

function ymd(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function parseYMD(s){
  const [y,m,d]=s.split("-").map(Number);
  return new Date(y, m-1, d);
}
function monthStart(y,m){ return new Date(y, m-1, 1); }
function addMonths(y,m,delta){
  const d=new Date(y, m-1, 1);
  d.setMonth(d.getMonth()+delta);
  return {y:d.getFullYear(), m:d.getMonth()+1};
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function isWeekend(d){ const w=d.getDay(); return w===0 || w===6; }

function defaultState(){
  const now=new Date();
  const by=now.getFullYear();
  const bm=now.getMonth()+1;
  const base = {year:by, month:bm};
  const chems = {};
  CHEMS.forEach(c=>{
    chems[c.id]={
      monthStartL: 0,
      dayUse:c.dayUse, nightUse:c.nightUse,
      line1cm:c.line1cm, line2cm:c.line2cm,
      inQty:c.inDefault
    };
  });
  return {
    base, leadDays: 14,
    chems,
    work: {},   // date -> {day:true/false, night:true/false}
    receipt: {},// date -> {naoh:0,fecl2:0,h2so4:0}
    measure: {},// date -> {naoh:null,...}
    view: {year:by, month:bm},
    range: 3
  };
}

let state = load();

function load(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const s=JSON.parse(raw);
    // migrate: ensure keys
    if(!s.chems) return defaultState();
    if(!s.view) s.view = {...s.base};
    if(!s.range) s.range = 3;
    return s;
  }catch(e){
    return defaultState();
  }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  toast("保存しました");
}
function toast(msg){
  const el=document.getElementById("viewLabel");
  const old=el.textContent;
  el.textContent = msg;
  setTimeout(()=>{ updateViewLabel(); }, 900);
}

function updateViewLabel(){
  const {year,month}=state.view;
  document.getElementById("viewLabel").textContent = `${year}年 ${month}月`;
}

function buildChemRows(){
  const tbody=document.getElementById("chemRows");
  tbody.innerHTML="";
  CHEMS.forEach(c=>{
    const v=state.chems[c.id];
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td><b>${c.name}</b></td>
      <td><input data-k="monthStartL" data-id="${c.id}" type="number" min="0" max="${MAX_L}" value="${v.monthStartL ?? 0}"></td>
      <td><input data-k="dayUse" data-id="${c.id}" type="number" step="0.1" min="0" value="${v.dayUse}"></td>
      <td><input data-k="nightUse" data-id="${c.id}" type="number" step="0.1" min="0" value="${v.nightUse}"></td>
      <td><input data-k="line1cm" data-id="${c.id}" type="number" min="0" max="200" value="${v.line1cm}"></td>
      <td><input data-k="line2cm" data-id="${c.id}" type="number" min="0" max="200" value="${v.line2cm}"></td>
      <td><input data-k="inQty" data-id="${c.id}" type="number" min="0" value="${v.inQty}"></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", ()=>{
      const id=inp.dataset.id;
      const k=inp.dataset.k;
      let val=parseFloat(inp.value||"0");
      if(k==="monthStartL") val = clamp(val,0,MAX_L);
      state.chems[id][k]=val;
      save();
      render();
    });
  });
}

function setBaseToTodayIfEmpty(){
  // if monthStartL are all 0 and base not explicitly set? leave; user can set.
}

function ensureWorkEntry(dateStr){
  if(!state.work[dateStr]){
    const d=parseYMD(dateStr);
    const wk = !isWeekend(d);
    state.work[dateStr]={day:wk, night:wk};
  }
}

function autoWeekdays(){
  // set visible months weekdays checked, weekend unchecked
  const months = monthsInRange();
  months.forEach(({y,m})=>{
    const start=monthStart(y,m);
    const end=new Date(y, m, 0);
    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const ds=ymd(d);
      ensureWorkEntry(ds);
      const wk=!isWeekend(d);
      state.work[ds].day=wk;
      state.work[ds].night=wk;
    }
  });
  save(); render();
}
function clearAll(){
  const months = monthsInRange();
  months.forEach(({y,m})=>{
    const start=monthStart(y,m);
    const end=new Date(y, m, 0);
    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const ds=ymd(d);
      ensureWorkEntry(ds);
      state.work[ds].day=false;
      state.work[ds].night=false;
    }
  });
  save(); render();
}

function monthsInRange(){
  const {year,month}=state.view;
  const list=[];
  for(let i=0;i<state.range;i++){
    const t=addMonths(year,month,i);
    list.push(t);
  }
  return list;
}

function getAnchorDate(){
  // base month start
  return monthStart(state.base.year, state.base.month);
}

function calcInventoryForDate(targetDate){
  // returns inventory for each chem at start of targetDate (morning before shifts and receipts)
  const anchor=getAnchorDate();
  const t= new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
  // if target before anchor, just return monthStartL as-is
  const inv = {};
  CHEMS.forEach(c=>{
    inv[c.id]= clamp(parseFloat(state.chems[c.id].monthStartL||0),0,MAX_L);
  });
  if(t < anchor) return inv;

  for(let d=new Date(anchor); d < t; d.setDate(d.getDate()+1)){
    const ds=ymd(d);
    ensureWorkEntry(ds);
    const w=state.work[ds];
    // apply receipts at day end? We'll apply receipts at start of day for simplicity on that date, so add first:
    const r=state.receipt[ds]||{};
    CHEMS.forEach(c=>{
      inv[c.id] = clamp(inv[c.id] + (parseFloat(r[c.id]||0)), 0, MAX_L);
    });
    // apply usage
    CHEMS.forEach(c=>{
      const use = (w.day?state.chems[c.id].dayUse:0) + (w.night?state.chems[c.id].nightUse:0);
      inv[c.id] = clamp(inv[c.id] - use, 0, MAX_L);
    });
    // apply measurement override (end-of-day measured replaces next morning base)
    const ms=state.measure[ds]||{};
    CHEMS.forEach(c=>{
      if(ms[c.id]!==undefined && ms[c.id]!==null && ms[c.id]!=="" ){
        const mv=parseFloat(ms[c.id]);
        if(!Number.isNaN(mv)) inv[c.id]=clamp(mv,0,MAX_L);
      }
    });
  }
  return inv;
}

function statusForChem(invL, chemId){
  const cm = invL / L_PER_CM;
  const l1 = state.chems[chemId].line1cm;
  const l2 = state.chems[chemId].line2cm;
  if(cm <= l2) return "danger";
  if(cm <= l1) return "warn";
  return "ok";
}

function renderKPI(){
  const box=document.getElementById("kpi");
  box.innerHTML="";
  const today=new Date();
  const inv=calcInventoryForDate(today);
  CHEMS.forEach(c=>{
    const l=inv[c.id];
    const cm = Math.round(l/L_PER_CM);
    const st=statusForChem(l,c.id);
    const tagClass = st==="ok"?"ok":(st==="warn"?"warn":"danger");
    const tagText = st==="ok"?"安全":(st==="warn"?"発注1付近":"発注2付近");
    // next dates for reaching line thresholds (simple forward simulation from today)
    const proj = projectReachDates(today, c.id, l);
    const lead = parseInt(state.leadDays||0);
    const sug1 = proj.d1 ? new Date(proj.d1.getTime()-lead*86400000) : null;
    const sug2 = proj.d2 ? new Date(proj.d2.getTime()-lead*86400000) : null;

    const div=document.createElement("div");
    div.className="box";
    div.innerHTML = `
      <div class="title">${c.name}</div>
      <div class="val">${Math.round(l)} L <span class="tag ${tagClass}" style="margin-left:8px">${tagText}</span></div>
      <div class="small">残量 ${cm} cm / 発注1:${state.chems[c.id].line1cm}cm 発注2:${state.chems[c.id].line2cm}cm</div>
      <div class="small">推定: 発注1到達 ${proj.d1?fmtMD(proj.d1):"—"} / 発注2到達 ${proj.d2?fmtMD(proj.d2):"—"}</div>
      <div class="small">推奨: 発注1 ${sug1?fmtMD(sug1):"—"} / 発注2 ${sug2?fmtMD(sug2):"—"}</div>
    `;
    box.appendChild(div);
  });
}

function fmtMD(d){ return `${d.getMonth()+1}/${d.getDate()}`; }

function projectReachDates(startDate, chemId, startL){
  const l1 = state.chems[chemId].line1cm * L_PER_CM;
  const l2 = state.chems[chemId].line2cm * L_PER_CM;
  let d1=null, d2=null;
  let inv=startL;
  let d=new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
  // simulate up to 180 days
  for(let i=0;i<180;i++){
    const ds=ymd(d);
    ensureWorkEntry(ds);
    const w=state.work[ds];
    const use = (w.day?state.chems[chemId].dayUse:0) + (w.night?state.chems[chemId].nightUse:0);
    const r=(state.receipt[ds]?.[chemId]||0);
    const m=(state.measure[ds]?.[chemId]);
    inv = clamp(inv + parseFloat(r||0),0,MAX_L);
    inv = clamp(inv - use,0,MAX_L);
    if(m!==undefined && m!==null && m!==""){
      const mv=parseFloat(m);
      if(!Number.isNaN(mv)) inv=clamp(mv,0,MAX_L);
    }
    if(!d1 && inv <= l1) d1=new Date(d);
    if(!d2 && inv <= l2) d2=new Date(d);
    if(d1 && d2) break;
    d.setDate(d.getDate()+1);
  }
  return {d1,d2};
}

function renderMonths(){
  const container=document.getElementById("months");
  container.innerHTML="";
  const list = monthsInRange();
  const todayStr=ymd(new Date());
  list.forEach(({y,m},idx)=>{
    const monthDiv=document.createElement("div");
    monthDiv.className="month";
    monthDiv.innerHTML = `<h3>${y}年 ${m}月</h3>`;
    const cal=document.createElement("div");
    cal.className="cal";
    ["日","月","火","水","木","金","土"].forEach(d=>{
      const el=document.createElement("div");
      el.className="dow";
      el.textContent=d;
      cal.appendChild(el);
    });

    const first=new Date(y,m-1,1);
    const last=new Date(y,m,0);
    const pad=first.getDay();
    for(let i=0;i<pad;i++){
      const blank=document.createElement("div");
      blank.className="day muted";
      blank.innerHTML="&nbsp;";
      cal.appendChild(blank);
    }
    for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)){
      const ds=ymd(d);
      ensureWorkEntry(ds);
      const invStart=calcInventoryForDate(d);
      const dayEl=document.createElement("div");
      dayEl.className="day";
      if(ds===todayStr) dayEl.classList.add("today");
      const w=state.work[ds];
      // status (worst among chems)
      const statuses = CHEMS.map(c=>statusForChem(invStart[c.id], c.id));
      const worst = statuses.includes("danger")?"danger":(statuses.includes("warn")?"warn":"ok");
      if(worst==="warn") dayEl.style.borderColor="rgba(251,191,36,.65)";
      if(worst==="danger") dayEl.style.borderColor="rgba(251,113,133,.8)";

      dayEl.innerHTML = `
        <div class="topline">
          <div class="dnum">${d.getDate()}</div>
          <div class="shift">
            <label>昼 <input class="chk" type="checkbox" data-d="${ds}" data-s="day" ${w.day?"checked":""}></label>
            <label>夜 <input class="chk" type="checkbox" data-d="${ds}" data-s="night" ${w.night?"checked":""}></label>
          </div>
        </div>
        <div class="mini">
          ${CHEMS.map(c=>{
            const l=Math.round(invStart[c.id]);
            const cm=Math.round(l/L_PER_CM);
            const st=statusForChem(l,c.id);
            const cls= st==="ok"?"okText":(st==="warn"?"warnText":"dangerText");
            return `<div class="line"><span>${c.name}</span><strong class="${cls}">${l}L (${cm}cm)</strong></div>`;
          }).join("")}
        </div>
      `;
      cal.appendChild(dayEl);
    }

    monthDiv.appendChild(cal);
    container.appendChild(monthDiv);
  });

  container.querySelectorAll("input[type=checkbox]").forEach(chk=>{
    chk.addEventListener("change", ()=>{
      const ds=chk.dataset.d;
      const s=chk.dataset.s;
      ensureWorkEntry(ds);
      state.work[ds][s]=chk.checked;
      save();
      render();
    });
  });
}

function setActiveTab(tabIdx){
  document.getElementById("tabThis").classList.toggle("active", tabIdx===0);
  document.getElementById("tabNext").classList.toggle("active", tabIdx===1);
  document.getElementById("tabNext2").classList.toggle("active", tabIdx===2);
}
function jumpTab(tabIdx){
  const {year,month}=state.view;
  const t=addMonths(year,month,tabIdx);
  state.view={year:t.y, month:t.m};
  save(); render();
}

function hookControls(){
  document.getElementById("saveBtn").addEventListener("click", ()=>{ save(); });
  document.getElementById("prevBtn").addEventListener("click", ()=>{
    const t=addMonths(state.view.year, state.view.month, -1);
    state.view={year:t.y, month:t.m};
    save(); render();
  });
  document.getElementById("nextBtn").addEventListener("click", ()=>{
    const t=addMonths(state.view.year, state.view.month, 1);
    state.view={year:t.y, month:t.m};
    save(); render();
  });
  document.getElementById("rangeSel").addEventListener("change", (e)=>{
    state.range=parseInt(e.target.value);
    save(); render();
  });

  document.getElementById("wkBtn").addEventListener("click", autoWeekdays);
  document.getElementById("clearBtn").addEventListener("click", clearAll);

  document.getElementById("tabThis").addEventListener("click", ()=>{ setActiveTab(0); });
  document.getElementById("tabNext").addEventListener("click", ()=>{ setActiveTab(1); jumpTab(1); });
  document.getElementById("tabNext2").addEventListener("click", ()=>{ setActiveTab(2); jumpTab(2); });

  // base settings
  document.getElementById("baseYear").addEventListener("change", (e)=>{
    state.base.year=parseInt(e.target.value||state.base.year);
    save(); render();
  });
  document.getElementById("baseMonth").addEventListener("change", (e)=>{
    state.base.month=clamp(parseInt(e.target.value||state.base.month),1,12);
    save(); render();
  });
  document.getElementById("leadDays").addEventListener("change", (e)=>{
    state.leadDays=clamp(parseInt(e.target.value||0),0,60);
    save(); render();
  });

  // export/import
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`乳化処理_在庫発注_${state.view.year}${String(state.view.month).padStart(2,'0')}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
  document.getElementById("importBtn").addEventListener("click", ()=>{
    document.getElementById("importFile").click();
  });
  document.getElementById("importFile").addEventListener("change", async (e)=>{
    const f=e.target.files?.[0];
    if(!f) return;
    const txt=await f.text();
    try{
      const s=JSON.parse(txt);
      state=s;
      save();
      render();
      alert("読込しました");
    }catch(err){
      alert("JSONが正しくありません");
    }
    e.target.value="";
  });
}

function render(){
  // top inputs
  document.getElementById("baseYear").value = state.base.year;
  document.getElementById("baseMonth").value = state.base.month;
  document.getElementById("leadDays").value = state.leadDays ?? 14;
  document.getElementById("rangeSel").value = String(state.range||3);

  updateViewLabel();
  buildChemRows();
  renderKPI();
  renderMonths();
}

window.addEventListener("load", ()=>{
  hookControls();
  render();
  // register service worker
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  }
});
</script>
</body>
</html>
