<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ä¹³åŒ–å‡¦ç† åœ¨åº«ãƒ»ç™ºæ³¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ2ãƒ¶æœˆè¡¨ç¤ºï¼‰</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1320" />
  <style>
    :root{
      --bg:#0b1320;
      --panel:#0f1b2e;
      --panel2:#0c1627;
      --text:#e8eefc;
      --muted:#9fb1d6;
      --accent:#32b5ff;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --danger:#ff5d7a;
      --danger2:#ff2e55;
      --line:#1f3557;
      --chip:#142743;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial, sans-serif;
      background: radial-gradient(1400px 700px at 10% -10%, rgba(50,181,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(46,229,157,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(to bottom, rgba(11,19,32,.92), rgba(11,19,32,.65));
      backdrop-filter: blur(10px);
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:260px;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(50,181,255,.95), rgba(46,229,157,.75));
      box-shadow: var(--shadow);
      display:grid;place-items:center;
      font-weight:800;
    }
    .brand h1{
      font-size:16px; margin:0; line-height:1.1;
    }
    .brand .sub{font-size:12px;color:var(--muted)}
    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .select, .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,27,46,.85);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .btn{
      cursor:pointer;
      user-select:none;
      display:inline-flex; gap:8px; align-items:center;
      font-weight:650;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background: linear-gradient(135deg, rgba(50,181,255,.95), rgba(46,229,157,.65)); border-color: transparent;}
    .btn.danger{background: rgba(255,93,122,.14); border-color: rgba(255,93,122,.32);}
    .btn.ghost{background: rgba(15,27,46,.55);}
    .btn.big{padding:12px 14px; font-size:15px; border-radius:16px;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,39,67,.65);
      color:var(--muted);
      font-size:12px;
    }
    .layout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      padding:14px;
      max-width: 1600px;
      margin: 0 auto;
    }
    @media (max-width: 1100px){
      .layout{grid-template-columns:1fr;}
    }
    .card{
      background: linear-gradient(180deg, rgba(15,27,46,.88), rgba(12,22,39,.78));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd .title{
      font-size:14px; margin:0; font-weight:800;
      display:flex; align-items:center; gap:8px;
    }
    .card .bd{padding:12px 14px;}
    .grid2{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .grid3{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;
    }
    .kpi{
      background: rgba(20,39,67,.35);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding:10px;
    }
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:900;margin-top:2px}
    .badge{
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,39,67,.55);
      font-size:12px; font-weight:800;
      display:inline-flex; align-items:center; gap:6px;
    }
    .b-ok{color:var(--ok); border-color: rgba(46,229,157,.35); background: rgba(46,229,157,.10)}
    .b-warn{color:var(--warn); border-color: rgba(255,204,102,.38); background: rgba(255,204,102,.10)}
    .b-danger{color:var(--danger2); border-color: rgba(255,46,85,.55); background: rgba(255,46,85,.10)}
    .blink{
      animation: blink 1.0s steps(1,end) infinite;
    }
    @keyframes blink{
      50%{filter:brightness(1.35)}
    }
    .tableWrap{overflow:auto; max-height: calc(100vh - 210px);}
    table{
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      min-width: 920px;
      font-size:13px;
    }
    th, td{
      padding:8px 8px;
      border-bottom:1px solid rgba(255,255,255,.06);
      white-space:nowrap;
      vertical-align:middle;
    }
    th{
      position:sticky;
      top:0;
      z-index:10;
      background: rgba(11,19,32,.92);
      color:var(--muted);
      font-size:12px;
      text-align:left;
    }
    .mBlock{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .mHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .mHeader .mh{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
    }
    .mHeader .mh .monthTitle{
      font-size:16px;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .inp{
      width:100%;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(8,14,26,.55);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    .tiny{font-size:11px;color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:54px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,39,67,.35);
      font-weight:850;
    }
    .p-warn{border-color: rgba(255,204,102,.45); background: rgba(255,204,102,.10); color: var(--warn);}
    .p-danger{border-color: rgba(255,46,85,.55); background: rgba(255,46,85,.12); color: var(--danger2);}
    .p-ok{border-color: rgba(46,229,157,.35); background: rgba(46,229,157,.10); color: var(--ok);}
    .ck{
      width:22px;height:22px;
      accent-color: var(--accent);
      transform: translateY(1px);
    }
    .rowAlert1 td.stockCell{background: rgba(255,204,102,.08);}
    .rowAlert2 td.stockCell{background: rgba(255,46,85,.10);}
    .rowAlert2 td.stockCell .pill{animation: blink 1.0s steps(1,end) infinite;}
    .sep{
      height:10px;
    }
    .monthsGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      padding:12px;
    }
    @media (min-width: 1350px){
      .monthsGrid{
        grid-template-columns: 1fr 1fr;
      }
      .tableWrap{max-height: calc(100vh - 265px);}
      table{min-width: 820px;}
    }
    .alertBanner{
      padding:10px 12px;
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,39,67,.35);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .alertBanner strong{font-size:13px}
    .alertBanner .msg{font-size:12px;color:var(--muted)}
    .alertBanner.danger{border-color: rgba(255,46,85,.55); background: rgba(255,46,85,.12);}
    .alertBanner.warn{border-color: rgba(255,204,102,.45); background: rgba(255,204,102,.10);}
  
    @media print{
      body{background:#fff;color:#000;}
      header{position:static;background:#fff;border-bottom:1px solid #ccc;}
      .topbar .controls, #btnSave, #btnReset, #btnPrev, #btnNext, #btnPrint, #chipView{display:none !important;}
      .layout{grid-template-columns: 1fr; padding:0;}
      .card{box-shadow:none;border:1px solid #ccc;}
      .monthsGrid{grid-template-columns: 1fr 1fr;}
      .sub{color:#333;}
      .kpi, .hint, .tiny, .msg{color:#111;}
      table{color:#000;}
    }


    .bulkBar{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-left:8px;
    }
    .bulkBar .btn{ padding:8px 10px; }
    </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo">æ¶²</div>
        <div>
          <h1>ä¹³åŒ–å‡¦ç† åœ¨åº«ãƒ»ç™ºæ³¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
          <div class="sub">2ãƒ¶æœˆåŒæ™‚è¡¨ç¤º / ã‚¢ãƒ©ãƒ¼ãƒˆå¼·åŒ–ï¼ˆä¿å­˜ã‚ã‚Šï¼‰</div>
        </div>
      </div>
      <div class="controls">
        <span class="chip" id="chipView">è¡¨ç¤ºï¼šä»Šæœˆ/æ¥æœˆ</span>
        <button class="btn big ghost" id="btnPrev">â—€ å‰ã®æœˆ</button>
        <select class="select" id="selYear"></select>
        <select class="select" id="selMonth"></select>
        <button class="btn big ghost" id="btnNext">æ¬¡ã®æœˆ â–¶</button>
        <button class="btn big ghost" id="btnPrint">ğŸ–¨ å°åˆ·</button>
        <button class="btn big primary" id="btnSave">ä¿å­˜</button>
        <button class="btn big danger" id="btnReset">åˆæœŸåŒ–</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT -->
    <section class="card" id="leftPanel">
      <div class="hd">
        <div class="title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ <span class="chip">é»„è‰²=ç¬¬1 / èµ¤=ç¬¬2</span></div>
        <span class="badge" id="badgeAll">OK</span>
      </div>
      <div class="bd">
        <div class="grid3" id="kpis"></div>

        <div class="alertBanner" id="alertBanner" style="display:none;">
          <div>
            <strong id="alertTitle">ã‚¢ãƒ©ãƒ¼ãƒˆ</strong>
            <div class="msg" id="alertMsg">å†…å®¹</div>
          </div>
          <span class="badge b-danger blink" id="alertBadge">è¦å¯¾å¿œ</span>
        </div>

        <div class="sep"></div>

        <div class="card" style="border-radius:14px;">
          <div class="hd">
            <div class="title">è¨­å®š <span class="chip">å…¥åŠ›ã§å³åæ˜ </span></div>
          </div>
          <div class="bd">
            <div class="hint">æœˆåˆåœ¨åº«(L)ã ã‘å…¥ã‚Œã‚Œã°OKã€‚ç¨¼åƒâ˜‘ã§æ¸›ç®—ã€å—å…¥ã§åŠ ç®—ã€‚å®Ÿæ¸¬/è£œæ­£ã¯ãã®æ—¥ã®åœ¨åº«ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚</div>
            <div class="sep"></div>

            <div class="grid2">
              <div class="kpi">
                <div class="k">ã‚¿ãƒ³ã‚¯æœ€å¤§(L)</div>
                <input class="inp" id="inpTankMax" type="number" min="0" step="1">
                <div class="tiny">ä¾‹ï¼š2000</div>
              </div>
              <div class="kpi">
                <div class="k">ç´æœŸ(å–¶æ¥­æ—¥)</div>
                <input class="inp" id="inpLeadDays" type="number" min="0" step="1">
                <div class="tiny">ä¾‹ï¼š14</div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="kpi">
              <div class="k" style="display:flex;justify-content:space-between;align-items:center;">
                <span>æœˆåˆåœ¨åº«(L)</span>
                <span class="tiny">â€»ä»Šæœˆã®æœˆåˆ</span>
              </div>
              <div class="grid3">
                <input class="inp" id="start_caustic" type="number" min="0" step="0.1" placeholder="è‹›æ€§ã‚½ãƒ¼ãƒ€">
                <input class="inp" id="start_ferric" type="number" min="0" step="0.1" placeholder="å¡©åŒ–ç¬¬äºŒé‰„">
                <input class="inp" id="start_sulfur" type="number" min="0" step="0.1" placeholder="å¸Œç¡«é…¸">
              </div>
            </div>

            <div class="sep"></div>

            <div class="kpi">
              <div class="k">æ˜¼ä½¿ç”¨(L) / å¤œä½¿ç”¨(L)</div>
              <div class="grid3">
                <div>
                  <div class="tiny">è‹›æ€§ã‚½ãƒ¼ãƒ€</div>
                  <input class="inp" id="use_day_caustic" type="number" step="0.1">
                  <input class="inp" id="use_night_caustic" type="number" step="0.1" style="margin-top:6px;">
                </div>
                <div>
                  <div class="tiny">å¡©åŒ–ç¬¬äºŒé‰„</div>
                  <input class="inp" id="use_day_ferric" type="number" step="0.1">
                  <input class="inp" id="use_night_ferric" type="number" step="0.1" style="margin-top:6px;">
                </div>
                <div>
                  <div class="tiny">å¸Œç¡«é…¸</div>
                  <input class="inp" id="use_day_sulfur" type="number" step="0.1">
                  <input class="inp" id="use_night_sulfur" type="number" step="0.1" style="margin-top:6px;">
                </div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="kpi">
              <div class="k">ç™ºæ³¨ãƒ©ã‚¤ãƒ³(L)</div>
              <div class="grid3">
                <div>
                  <div class="tiny">è‹›æ€§ã‚½ãƒ¼ãƒ€ ç¬¬1/ç¬¬2</div>
                  <input class="inp" id="line1_caustic" type="number" step="1">
                  <input class="inp" id="line2_caustic" type="number" step="1" style="margin-top:6px;">
                </div>
                <div>
                  <div class="tiny">å¡©åŒ–ç¬¬äºŒé‰„ ç¬¬1/ç¬¬2</div>
                  <input class="inp" id="line1_ferric" type="number" step="1">
                  <input class="inp" id="line2_ferric" type="number" step="1" style="margin-top:6px;">
                </div>
                <div>
                  <div class="tiny">å¸Œç¡«é…¸ ç¬¬1/ç¬¬2</div>
                  <input class="inp" id="line1_sulfur" type="number" step="1">
                  <input class="inp" id="line2_sulfur" type="number" step="1" style="margin-top:6px;">
                </div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="kpi">
              <div class="k">å…¥è·é‡(L)</div>
              <div class="grid3">
                <input class="inp" id="in_caustic" type="number" step="1" placeholder="è‹›æ€§ã‚½ãƒ¼ãƒ€">
                <input class="inp" id="in_ferric" type="number" step="1" placeholder="å¡©åŒ–ç¬¬äºŒé‰„">
                <input class="inp" id="in_sulfur" type="number" step="1" placeholder="å¸Œç¡«é…¸">
              </div>
            </div>

            <div class="sep"></div>

            <button class="btn big ghost" id="btnWeekdayOn">å¹³æ—¥ON / åœŸæ—¥OFFï¼ˆä»Šæœˆï¼‰</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="hd">
        <div class="title">2ãƒ¶æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ <span class="chip">ä»Šæœˆ=ç·¨é›† / æ¥æœˆ=äºˆæ¸¬</span></div>
        <div class="controls">
          <span class="chip" id="chipInfo">ãƒã‚§ãƒƒã‚¯ã§åœ¨åº«ãŒæ¸›ã‚Šã¾ã™</span>
        <div class="bulkBar">
          <select id="bulkTarget" class="select" title="ä¸€æ‹¬ãƒã‚§ãƒƒã‚¯ã®å¯¾è±¡">
            <option value="both">ä»Šæœˆ+æ¥æœˆ</option>
            <option value="this">ä»Šæœˆã®ã¿</option>
            <option value="next">æ¥æœˆã®ã¿</option>
          </select>
          <button class="btn ghost" id="btnBulkAll">å¹³æ—¥ æ˜¼å¤œ</button>
          <button class="btn ghost" id="btnBulkDay">å¹³æ—¥ æ˜¼</button>
          <button class="btn ghost" id="btnBulkNight">å¹³æ—¥ å¤œ</button>
          <button class="btn ghost" id="btnBulkClear">å¹³æ—¥ è§£é™¤</button>
        </div>

        </div>
      </div>
      <div class="monthsGrid" id="monthsGrid"></div>
    </section>
  </div>

<script>
/* =====================
   Storage + Defaults
===================== */
const LS_KEY = "nyuu_pwa_v3m_alert";
const clone = (o) => (typeof structuredClone === "function" ? structuredClone(o) : JSON.parse(JSON.stringify(o)));
const CHEMS = [
  { key:"caustic", label:"è‹›æ€§ã‚½ãƒ¼ãƒ€" },
  { key:"ferric",  label:"å¡©åŒ–ç¬¬äºŒé‰„" },
  { key:"sulfur",  label:"å¸Œç¡«é…¸" }
];

const defaults = {
  tankMax: 2000,
  leadDays: 14,
  startYear: new Date().getFullYear(),
  startMonth: new Date().getMonth()+1,
  startInventory: { caustic:830, ferric:130, sulfur:114 },
  use: {
    day:   { caustic:4, ferric:2, sulfur:0.5 },
    night: { caustic:4, ferric:2, sulfur:0.5 }
  },
  line1: { caustic:1700, ferric:700, sulfur:300 },
  line2: { caustic:1000, ferric:700, sulfur:300 },
  incoming: { caustic:600, ferric:1500, sulfur:1500 },
  monthStartMap: {
    // "YYYY-MM": { caustic:..., ferric:..., sulfur:... }
  },
  // per-date overrides
  days: {
    // "YYYY-MM-DD": { dayOn:true, nightOn:true, receive:{...}, adjust:{...} }
  }
};

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return clone(defaults);
    const obj = JSON.parse(raw);
    // merge shallow
    return deepMerge(clone(defaults), obj);
  }catch(e){
    console.warn(e);
    return clone(defaults);
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function deepMerge(a,b){
  for(const k in b){
    if(b[k] && typeof b[k]==="object" && !Array.isArray(b[k])){
      if(!a[k] || typeof a[k]!=="object") a[k]={};
      deepMerge(a[k], b[k]);
    }else{
      a[k]=b[k];
    }
  }
  return a;
}
let state = loadState();

/* =====================
   Date helpers
===================== */
function fmt(x){
  if(x===null || x===undefined || x==="") return "";
  const n = Number(x);
  if(Number.isNaN(n)) return "";
  return (Math.round(n*10)/10).toString();
}
function pad(n){ return String(n).padStart(2,"0"); }
function keyDate(y,m,d){ return `${y}-${pad(m)}-${pad(d)}`; }
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
const W = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
function weekday(y,m,d){ return new Date(y,m-1,d).getDay(); }
function addMonths(y,m,delta){
  const dt = new Date(y, m-1+delta, 1);
  return { y: dt.getFullYear(), m: dt.getMonth()+1 };
}
function compareYM(aY,aM,bY,bM){
  if(aY!==bY) return aY-bY;
  return aM-bM;
}

/* =====================
   Compute inventories sequentially from (startYear/startMonth/1)
===================== */
function getDayRec(dateKey){
  return state.days[dateKey] || null;
}
function setDayRec(dateKey, rec){
  state.days[dateKey] = rec;
}
function ensureDayRec(dateKey){
  if(!state.days[dateKey]) state.days[dateKey] = { dayOn:false, nightOn:false, receive:{}, adjust:{} };
  if(!state.days[dateKey].receive) state.days[dateKey].receive = {};
  if(!state.days[dateKey].adjust) state.days[dateKey].adjust = {};
  return state.days[dateKey];
}

function computeRange(fromY, fromM, monthsCount){
  // compute from startYM up to endYM inclusive, but only return requested months
  const startY = state.startYear;
  const startM = state.startMonth;

  // We need beginning inventory at start date
  let inv = clone(state.startInventory);

  // Iterate months from startYM to target end
  const end = addMonths(fromY, fromM, monthsCount-1);
  const months = [];
  // We'll build a map of month key => list days
  const want = [];
  for(let i=0;i<monthsCount;i++){
    const ym = addMonths(fromY, fromM, i);
    want.push(`${ym.y}-${pad(ym.m)}`);
  }

  let curY = startY, curM = startM;

  function monthKey(y,m){ return `${y}-${pad(m)}`; }

  // helper to process one month
  function processMonth(y,m, invStart){
    const dim = daysInMonth(y,m);
    const rows = [];
    let invCur = clone(invStart);

    for(let d=1; d<=dim; d++){
      const dk = keyDate(y,m,d);
      const rec = ensureDayRec(dk);
      // default pattern if not set explicitly: keep as stored; do not auto change here
      let dayOn = !!rec.dayOn;
      let nightOn = !!rec.nightOn;

      // Apply receive before usage? In practice receive can happen daytime; we apply receive first then usage to be safe.
      for(const c of CHEMS){
        const add = Number(rec.receive?.[c.key] || 0);
        invCur[c.key] += add;
      }

      // Apply usage
      if(dayOn){
        for(const c of CHEMS){
          invCur[c.key] -= Number(state.use.day[c.key] || 0);
        }
      }
      if(nightOn){
        for(const c of CHEMS){
          invCur[c.key] -= Number(state.use.night[c.key] || 0);
        }
      }

      // Apply adjust/measurement override if provided (>0 or >=0)
      for(const c of CHEMS){
        const adjVal = rec.adjust?.[c.key];
        if(adjVal !== undefined && adjVal !== null && adjVal !== "" && !Number.isNaN(Number(adjVal))){
          invCur[c.key] = Number(adjVal);
        }
        // clamp
        if(invCur[c.key] < 0) invCur[c.key] = 0;
        if(invCur[c.key] > state.tankMax) invCur[c.key] = state.tankMax;
      }

      const status = {};
      for(const c of CHEMS){
        const v = invCur[c.key];
        if(v <= state.line2[c.key]) status[c.key] = 2;
        else if(v <= state.line1[c.key]) status[c.key] = 1;
        else status[c.key] = 0;
      }

      rows.push({ y,m,d, dk, w:weekday(y,m,d), dayOn, nightOn, inv: clone(invCur), status, receive: clone(rec.receive||{}), adjust: clone(rec.adjust||{}) });
    }

    return { y,m, startInv: invStart, endInv: rows[rows.length-1]?.inv || clone(invStart), rows };
  }

  // Move curYM forward until reaching endYM
  while(compareYM(curY,curM,end.y,end.m) <= 0){
    const mk = monthKey(curY,curM);
    const mdata = processMonth(curY,curM, inv);
    inv = clone(mdata.endInv);

    if(want.includes(mk)){
      months.push(mdata);
    }
    const next = addMonths(curY,curM,1);
    curY = next.y; curM = next.m;
  }

  return months;
}

/* =====================
   UI rendering
===================== */
const selYear = document.getElementById("selYear");
const selMonth = document.getElementById("selMonth");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");
const btnSave = document.getElementById("btnSave");
const btnReset = document.getElementById("btnReset");
const btnPrint = document.getElementById("btnPrint");
const btnWeekdayOn = document.getElementById("btnWeekdayOn");
const monthsGrid = document.getElementById("monthsGrid");
const kpis = document.getElementById("kpis");
const badgeAll = document.getElementById("badgeAll");
const alertBanner = document.getElementById("alertBanner");
const alertTitle = document.getElementById("alertTitle");
const alertMsg = document.getElementById("alertMsg");

let viewY = state.startYear;
let viewM = state.startMonth;

function initSelectors(){
  selYear.innerHTML="";
  const y0 = state.startYear-1;
  for(let y=y0; y<=y0+6; y++){
    const opt=document.createElement("option");
    opt.value=y; opt.textContent=`${y}å¹´`;
    selYear.appendChild(opt);
  }
  selMonth.innerHTML="";
  for(let m=1;m<=12;m++){
    const opt=document.createElement("option");
    opt.value=m; opt.textContent=`${m}æœˆ`;
    selMonth.appendChild(opt);
  }
  selYear.value=viewY;
  selMonth.value=viewM;
}

function bindSettings(){
  // Tank max + lead
  document.getElementById("inpTankMax").value = state.tankMax;
  document.getElementById("inpLeadDays").value = state.leadDays;

  // Start inventories (for view month as start month concept)
  document.getElementById("start_caustic").value = state.startInventory.caustic;
  document.getElementById("start_ferric").value  = state.startInventory.ferric;
  document.getElementById("start_sulfur").value  = state.startInventory.sulfur;

  // usage
  document.getElementById("use_day_caustic").value   = state.use.day.caustic;
  document.getElementById("use_night_caustic").value = state.use.night.caustic;
  document.getElementById("use_day_ferric").value    = state.use.day.ferric;
  document.getElementById("use_night_ferric").value  = state.use.night.ferric;
  document.getElementById("use_day_sulfur").value    = state.use.day.sulfur;
  document.getElementById("use_night_sulfur").value  = state.use.night.sulfur;

  // lines
  document.getElementById("line1_caustic").value = state.line1.caustic;
  document.getElementById("line2_caustic").value = state.line2.caustic;
  document.getElementById("line1_ferric").value  = state.line1.ferric;
  document.getElementById("line2_ferric").value  = state.line2.ferric;
  document.getElementById("line1_sulfur").value  = state.line1.sulfur;
  document.getElementById("line2_sulfur").value  = state.line2.sulfur;

  // incoming
  document.getElementById("in_caustic").value = state.incoming.caustic;
  document.getElementById("in_ferric").value  = state.incoming.ferric;
  document.getElementById("in_sulfur").value  = state.incoming.sulfur;

  // bind change events
  const ids = [
    "inpTankMax","inpLeadDays",
    "start_caustic","start_ferric","start_sulfur",
    "use_day_caustic","use_night_caustic","use_day_ferric","use_night_ferric","use_day_sulfur","use_night_sulfur",
    "line1_caustic","line2_caustic","line1_ferric","line2_ferric","line1_sulfur","line2_sulfur",
    "in_caustic","in_ferric","in_sulfur"
  ];
  for(const id of ids){
    const el=document.getElementById(id);
    el.onchange = () => {
      applySettingsFromUI();
      renderAll();
    };
  }
}

function applySettingsFromUI(){
  state.tankMax = Number(document.getElementById("inpTankMax").value || 0);
  state.leadDays = Number(document.getElementById("inpLeadDays").value || 0);

  state.startYear = Number(selYear.value);
  state.startMonth = Number(selMonth.value);

  state.startInventory.caustic = Number(document.getElementById("start_caustic").value || 0);
  state.startInventory.ferric  = Number(document.getElementById("start_ferric").value  || 0);
  state.startInventory.sulfur  = Number(document.getElementById("start_sulfur").value  || 0);

  state.use.day.caustic = Number(document.getElementById("use_day_caustic").value || 0);
  state.use.night.caustic = Number(document.getElementById("use_night_caustic").value || 0);
  state.use.day.ferric = Number(document.getElementById("use_day_ferric").value || 0);
  state.use.night.ferric = Number(document.getElementById("use_night_ferric").value || 0);
  state.use.day.sulfur = Number(document.getElementById("use_day_sulfur").value || 0);
  state.use.night.sulfur = Number(document.getElementById("use_night_sulfur").value || 0);

  state.line1.caustic = Number(document.getElementById("line1_caustic").value || 0);
  state.line2.caustic = Number(document.getElementById("line2_caustic").value || 0);
  state.line1.ferric = Number(document.getElementById("line1_ferric").value || 0);
  state.line2.ferric = Number(document.getElementById("line2_ferric").value || 0);
  state.line1.sulfur = Number(document.getElementById("line1_sulfur").value || 0);
  state.line2.sulfur = Number(document.getElementById("line2_sulfur").value || 0);

  state.incoming.caustic = Number(document.getElementById("in_caustic").value || 0);
  state.incoming.ferric  = Number(document.getElementById("in_ferric").value  || 0);
  state.incoming.sulfur  = Number(document.getElementById("in_sulfur").value  || 0);
}


function ymKey(y,m){ return `${y}-${pad(m)}`; }

function setStartInventoryInputs(invObj){
  document.getElementById("start_caustic").value = Math.round((invObj.caustic||0)*10)/10;
  document.getElementById("start_ferric").value  = Math.round((invObj.ferric||0)*10)/10;
  document.getElementById("start_sulfur").value  = Math.round((invObj.sulfur||0)*10)/10;
  // reflect into state too
  state.startInventory.caustic = Number(document.getElementById("start_caustic").value || 0);
  state.startInventory.ferric  = Number(document.getElementById("start_ferric").value  || 0);
  state.startInventory.sulfur  = Number(document.getElementById("start_sulfur").value  || 0);
}

function getCurrentMonthEndInv(y,m){
  applySettingsFromUI(); // sync latest
  const ms = computeRange(y,m,1);
  return ms[0]?.endInv ? clone(ms[0].endInv) : clone(state.startInventory);
}

function autoCarryoverIfNeeded(fromY,fromM,toY,toM){
  const delta = (toY-fromY)*12 + (toM-fromM);
  if(delta===1){
    const endInv = getCurrentMonthEndInv(fromY,fromM);
    state.monthStartMap[ymKey(toY,toM)] = clone(endInv);
    setStartInventoryInputs(endInv);
  }else{
    const stored = state.monthStartMap[ymKey(toY,toM)];
    if(stored){
      setStartInventoryInputs(stored);
    }
  }
}



function renderKPI(months){
  // Show current month first day start inventory and last known (today or end of month) as "ç¾åœ¨"
  const m0 = months[0];
  // pick day = today if same month else first day
  const now = new Date();
  const todayKey = keyDate(now.getFullYear(), now.getMonth()+1, now.getDate());
  let currentInv = m0.rows[0]?.inv || clone(state.startInventory);
  for(const r of m0.rows){
    if(r.dk === todayKey){
      currentInv = r.inv; break;
    }
  }
  kpis.innerHTML="";
  let worst = 0;
  let worstChem = null;
  for(const c of CHEMS){
    const v = Math.round(currentInv[c.key]*10)/10;
    const st = (v <= state.line2[c.key]) ? 2 : (v <= state.line1[c.key]) ? 1 : 0;
    if(st>worst){ worst=st; worstChem=c.label; }

    const div=document.createElement("div");
    div.className="kpi";
    div.innerHTML = `
      <div class="k">${c.label} ç¾åœ¨</div>
      <div class="v">${v}</div>
      <div class="tiny">ç¬¬1:${state.line1[c.key]} / ç¬¬2:${state.line2[c.key]}</div>
      <div style="margin-top:6px;">
        <span class="badge ${st===0?'b-ok':st===1?'b-warn':'b-danger'} ${st===2?'blink':''}">
          ${st===0?'OK':st===1?'ç¬¬1':'ç¬¬2'}
        </span>
      </div>
    `;
    kpis.appendChild(div);
  }

  if(worst===0){
    badgeAll.className="badge b-ok";
    badgeAll.textContent="OK";
    alertBanner.style.display="none";
  }else if(worst===1){
    badgeAll.className="badge b-warn";
    badgeAll.textContent="ç¬¬1ãƒ©ã‚¤ãƒ³æ³¨æ„";
    alertBanner.style.display="flex";
    alertBanner.className="alertBanner warn";
    alertTitle.textContent = "ç¬¬1ãƒ©ã‚¤ãƒ³ã«è¿‘ã¥ã„ã¦ã„ã¾ã™";
    alertMsg.textContent = `${worstChem} ãŒç¬¬1ãƒ©ã‚¤ãƒ³ä»¥ä¸‹ã§ã™ã€‚ç™ºæ³¨æº–å‚™ã‚’ã—ã¦ãã ã•ã„ã€‚`;
  }else{
    badgeAll.className="badge b-danger blink";
    badgeAll.textContent="ç¬¬2ãƒ©ã‚¤ãƒ³å±é™º";
    alertBanner.style.display="flex";
    alertBanner.className="alertBanner danger";
    alertTitle.textContent = "ç¬¬2ãƒ©ã‚¤ãƒ³ã«åˆ°é”ï¼ˆè¦å¯¾å¿œï¼‰";
    alertMsg.textContent = `${worstChem} ãŒç¬¬2ãƒ©ã‚¤ãƒ³ä»¥ä¸‹ã§ã™ã€‚è‡³æ€¥å¯¾å¿œã—ã¦ãã ã•ã„ã€‚`;
  }
}


function buildMonthBlock(mdata, mode){
  const allowChecks = (mode !== "view");      // ãƒã‚§ãƒƒã‚¯ã¯ç·¨é›†ã§ãã‚‹ã‹
  const allowInputs = (mode === "full");     // å—å…¥/è£œæ­£ã®å…¥åŠ›ã‚‚ã§ãã‚‹ã‹

  const wrap=document.createElement("div");
  wrap.className="card";
  wrap.style.borderRadius="16px";

  const ymTitle = `${mdata.y}å¹´ ${mdata.m}æœˆ`;
  const tag = allowInputs
    ? `<span class="chip">ç·¨é›†</span>`
    : (allowChecks ? `<span class="chip">äºˆæ¸¬(ãƒã‚§ãƒƒã‚¯å¯)</span>` : `<span class="chip">äºˆæ¸¬</span>`);

  const head=document.createElement("div");
  head.className="mBlock";
  head.innerHTML = `
    <div class="mHeader">
      <div class="mTitle">${ymTitle} ${tag}</div>
      <div class="mHint">
        ${allowInputs
          ? "ãƒã‚§ãƒƒã‚¯ã§ä½¿ç”¨é‡ã‚’æ¸›ç®—ã€‚å—å…¥/è£œæ­£ã¯ã“ã®æœˆã ã‘å…¥åŠ›ã§ãã¾ã™ã€‚"
          : (allowChecks ? "ãƒã‚§ãƒƒã‚¯ã¯å…¥åŠ›ã§ãã¾ã™ï¼ˆäºˆæ¸¬ç”¨ï¼‰ã€‚å—å…¥/è£œæ­£ã¯ä»Šæœˆã ã‘ã€‚" : "é–²è¦§ã®ã¿")}
      </div>
    </div>
  `;
  wrap.appendChild(head);

  const table=document.createElement("table");
  table.className="tbl";

  // Receive/Adjust columns: ä»Šæœˆ(ãƒ•ãƒ«)ã ã‘è¡¨ç¤º
  const thReceive = allowInputs ? `
        <th>è‹›æ€§ å—å…¥</th><th>å¡©äºŒé‰„ å—å…¥</th><th>å¸Œç¡«é…¸ å—å…¥</th>
        <th>è‹›æ€§ è£œæ­£</th><th>å¡©äºŒé‰„ è£œæ­£</th><th>å¸Œç¡«é…¸ è£œæ­£</th>
  ` : "";

  table.innerHTML = `
    <thead>
      <tr>
        <th>æ—¥</th><th>æ›œ</th><th>æ˜¼</th><th>å¤œ</th>
        <th>è‹›æ€§ åœ¨åº«</th><th>å¡©äºŒé‰„ åœ¨åº«</th><th>å¸Œç¡«é…¸ åœ¨åº«</th>
        ${thReceive}
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector("tbody");

  for(const r of mdata.rows){
    const tr=document.createElement("tr");
    // Row alert based on any chem status
    const sMax = Math.max(r.status.caustic, r.status.ferric, r.status.sulfur);
    if(sMax===1) tr.classList.add("rowAlert1");
    if(sMax===2) tr.classList.add("rowAlert2");

    const wLabel = W[r.w];

    const dayCk = allowChecks
      ? `<input type="checkbox" class="ck" data-dk="${r.dk}" data-k="dayOn" ${r.dayOn?'checked':''}>`
      : (r.dayOn ? "â˜‘" : "â˜");
    const nightCk = allowChecks
      ? `<input type="checkbox" class="ck" data-dk="${r.dk}" data-k="nightOn" ${r.nightOn?'checked':''}>`
      : (r.nightOn ? "â˜‘" : "â˜");

    const invCell = (v,st)=> `<span class="pill ${st===0?'p-ok':st===1?'p-warn':'p-danger'}">${fmt(v)}</span>`;

    // Inputs only for full month
    const recInputs = allowInputs ? `
      <td><input class="inp" data-dk="${r.dk}" data-r="receive" data-c="caustic" value="${r.receive.caustic ?? ""}"></td>
      <td><input class="inp" data-dk="${r.dk}" data-r="receive" data-c="ferric" value="${r.receive.ferric ?? ""}"></td>
      <td><input class="inp" data-dk="${r.dk}" data-r="receive" data-c="sulfur" value="${r.receive.sulfur ?? ""}"></td>
      <td><input class="inp" data-dk="${r.dk}" data-r="adjust"  data-c="caustic" value="${r.adjust.caustic ?? ""}"></td>
      <td><input class="inp" data-dk="${r.dk}" data-r="adjust"  data-c="ferric" value="${r.adjust.ferric ?? ""}"></td>
      <td><input class="inp" data-dk="${r.dk}" data-r="adjust"  data-c="sulfur" value="${r.adjust.sulfur ?? ""}"></td>
    ` : "";

    tr.innerHTML = `
      <td>${r.d}</td>
      <td class="${(r.w===0||r.w===6)?'wknd':''}">${wLabel}</td>
      <td class="ckCell">${dayCk}</td>
      <td class="ckCell">${nightCk}</td>
      <td>${invCell(r.inv.caustic, r.status.caustic)}</td>
      <td>${invCell(r.inv.ferric,  r.status.ferric)}</td>
      <td>${invCell(r.inv.sulfur,  r.status.sulfur)}</td>
      ${recInputs}
    `;
    tbody.appendChild(tr);
  }

  wrap.appendChild(table);

  // Bind events (checkboxes)
  if(allowChecks){
    wrap.querySelectorAll("input.ck").forEach(ck=>{
      ck.addEventListener("change",()=>{
        const dk = ck.dataset.dk;
        const k = ck.dataset.k;
        const rec = ensureDayRec(dk);
        rec[k] = ck.checked;
        renderAll(false); // re-render
      });
    });
  }

  // Bind inputs for receive/adjust (full month only)
  if(allowInputs){
    wrap.querySelectorAll("input.inp[data-dk]").forEach(inp=>{
      inp.addEventListener("change",()=>{
        const dk = inp.dataset.dk;
        const recType = inp.dataset.r;
        const chem = inp.dataset.c;
        const rec = ensureDayRec(dk);
        const v = inp.value;
        if(recType==="receive"){
          rec.receive[chem] = (v===""? "" : Number(v));
        }else{
          rec.adjust[chem] = (v===""? "" : Number(v));
        }
        renderAll(false);
      });
    });
  }

  return wrap;
}

function renderMonths(){
  monthsGrid.innerHTML="";
  // Important: viewY/viewM acts as "ä»Šæœˆ" anchor
  // Set startYear/startMonth to viewY/viewM (so month change keeps carryover)
  state.startYear = viewY;
  state.startMonth = viewM;

  // compute 2 months from view
  const months = computeRange(viewY, viewM, 2);
  renderKPI(months);

  months.forEach((m,idx)=>{
    monthsGrid.appendChild(buildMonthBlock(m, idx===0 ? "full" : "checks"));
  });
}

function renderAll(updateSelectors=true){
  if(updateSelectors){
    selYear.value = viewY;
    selMonth.value = viewM;
  }
  applySettingsFromUI(); // keep settings synced (also sets startYM)
  renderMonths();
}

function setMonth(y,m){
  viewY=y; viewM=m;
  initSelectors();
  bindSettings();
  renderAll();
}

/* =====================
   Actions
===================== */
btnPrev.addEventListener("click",()=>{
  const curY=viewY, curM=viewM;
  const prev = addMonths(viewY, viewM, -1);
  autoCarryoverIfNeeded(curY,curM,prev.y,prev.m);
  viewY = prev.y; viewM = prev.m;
  renderAll();
});
btnNext.addEventListener("click",()=>{
  const curY=viewY, curM=viewM;
  const next = addMonths(viewY, viewM, 1);
  autoCarryoverIfNeeded(curY,curM,next.y,next.m);
  viewY = next.y; viewM = next.m;
  renderAll();
});
selYear.addEventListener("change",()=>{
  const curY=viewY, curM=viewM;
  const newY = Number(selYear.value);
  autoCarryoverIfNeeded(curY,curM,newY,curM);
  viewY = newY;
  renderAll();
});
selMonth.addEventListener("change",()=>{
  const curY=viewY, curM=viewM;
  const newM = Number(selMonth.value);
  autoCarryoverIfNeeded(curY,curM,curY,newM);
  viewM = newM;
  renderAll();
});

btnSave.addEventListener("click",()=>{
  applySettingsFromUI();
  saveState();
  const chip=document.getElementById("chipInfo");
  chip.textContent="ä¿å­˜ã—ã¾ã—ãŸ âœ…";
  setTimeout(()=>chip.textContent="ãƒã‚§ãƒƒã‚¯ã§åœ¨åº«ãŒæ¸›ã‚Šã¾ã™", 1200);
});

btnPrint.addEventListener("click",()=>{ window.print(); });

btnReset.addEventListener("click",()=>{
  if(!confirm("åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™ï¼‰")) return;
  localStorage.removeItem(LS_KEY);
  state = clone(defaults);
  viewY = state.startYear;
  viewM = state.startMonth;
  initSelectors();
  bindSettings();
  renderAll();
});

btnWeekdayOn.addEventListener("click",()=>{
  // Apply weekday on / weekend off for current view month only
  const dim = daysInMonth(viewY, viewM);
  for(let d=1; d<=dim; d++){
    const w = weekday(viewY, viewM, d);
    const dk = keyDate(viewY, viewM, d);
    const rec = ensureDayRec(dk);
    if(w===0 || w===6){
      rec.dayOn=false; rec.nightOn=false;
    }else{
      rec.dayOn=true; rec.nightOn=true;
    }
  }
  renderAll(false);
});

/* =====================
   Boot
===================== */
(function boot(){
  // Register SW
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
  // Initial view = stored start
  viewY = state.startYear;
  viewM = state.startMonth;
  initSelectors();
  bindSettings();
  renderAll();

})();
</script>
</body>
</html>